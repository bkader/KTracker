local a=21;local _G=_G;if _G.ChatThrottleLib then if _G.ChatThrottleLib.version>=a then return elseif not _G.ChatThrottleLib.securelyHooked then print("ChatThrottleLib: Warning: There's an ANCIENT ChatThrottleLib.lua (pre-wow 2.0, <v16) in an addon somewhere. Get the addon updated or copy in a newer ChatThrottleLib.lua (>=v16) in it!")_G.SendChatMessage=_G.ChatThrottleLib.ORIG_SendChatMessage;if _G.ChatThrottleLib.ORIG_SendAddonMessage then _G.SendAddonMessage=_G.ChatThrottleLib.ORIG_SendAddonMessage end end;_G.ChatThrottleLib.ORIG_SendChatMessage=nil;_G.ChatThrottleLib.ORIG_SendAddonMessage=nil end;if not _G.ChatThrottleLib then _G.ChatThrottleLib={}end;ChatThrottleLib=_G.ChatThrottleLib;local ChatThrottleLib=_G.ChatThrottleLib;ChatThrottleLib.version=a;ChatThrottleLib.MAX_CPS=800;ChatThrottleLib.MSG_OVERHEAD=40;ChatThrottleLib.BURST=4000;ChatThrottleLib.MIN_FPS=20;local setmetatable=setmetatable;local b=table.remove;local tostring=tostring;local GetTime=GetTime;local c=math.min;local d=math.max;local next=next;local e=string.len;local GetFrameRate=GetFrameRate;local f={}local g={__index=f}function f:New()local h={}setmetatable(h,g)return h end;function f:Add(i)if self.pos then i.prev=self.pos.prev;i.prev.next=i;i.next=self.pos;i.next.prev=i else i.next=i;i.prev=i;self.pos=i end end;function f:Remove(i)i.next.prev=i.prev;i.prev.next=i.next;if self.pos==i then self.pos=i.next;if self.pos==i then self.pos=nil end end end;ChatThrottleLib.PipeBin=nil;local j=setmetatable({},{__mode="k"})local function k(l)for m=#l,1,-1 do l[m]=nil end;l.prev=nil;l.next=nil;j[l]=true end;local function n()local l=next(j)if l then j[l]=nil;return l end;return{}end;ChatThrottleLib.MsgBin=nil;local o=setmetatable({},{__mode="k"})local function p(q)q[1]=nil;o[q]=true end;local function r()local q=next(o)if q then o[q]=nil;return q end;return{}end;function ChatThrottleLib:Init()if not self.Prio then self.Prio={}self.Prio["ALERT"]={ByName={},Ring=f:New(),avail=0}self.Prio["NORMAL"]={ByName={},Ring=f:New(),avail=0}self.Prio["BULK"]={ByName={},Ring=f:New(),avail=0}end;for s,t in pairs(self.Prio)do t.nTotalSent=t.nTotalSent or 0 end;if not self.avail then self.avail=0 end;if not self.nTotalSent then self.nTotalSent=0 end;if not self.Frame then self.Frame=CreateFrame("Frame")self.Frame:Hide()end;self.Frame:SetScript("OnUpdate",self.OnUpdate)self.Frame:SetScript("OnEvent",self.OnEvent)self.Frame:RegisterEvent("PLAYER_ENTERING_WORLD")self.OnUpdateDelay=0;self.LastAvailUpdate=GetTime()self.HardThrottlingBeginTime=GetTime()if not self.securelyHooked then self.securelyHooked=true;hooksecurefunc("SendChatMessage",function(...)return ChatThrottleLib.Hook_SendChatMessage(...)end)hooksecurefunc("SendAddonMessage",function(...)return ChatThrottleLib.Hook_SendAddonMessage(...)end)end;self.nBypass=0 end;local u=false;function ChatThrottleLib.Hook_SendChatMessage(v,w,x,y,...)if u then return end;local self=ChatThrottleLib;local z=e(tostring(v or""))+e(tostring(y or""))+self.MSG_OVERHEAD;self.avail=self.avail-z;self.nBypass=self.nBypass+z end;function ChatThrottleLib.Hook_SendAddonMessage(A,v,w,y,...)if u then return end;local self=ChatThrottleLib;local z=tostring(v or""):len()+tostring(A or""):len()z=z+tostring(y or""):len()+self.MSG_OVERHEAD;self.avail=self.avail-z;self.nBypass=self.nBypass+z end;function ChatThrottleLib:UpdateAvail()local B=GetTime()local C=self.MAX_CPS;local D=C*(B-self.LastAvailUpdate)local E=self.avail;if B-self.HardThrottlingBeginTime<5 then E=c(E+D*0.1,C*0.5)self.bChoking=true elseif GetFramerate()<self.MIN_FPS then E=c(C,E+D*0.5)self.bChoking=true else E=c(self.BURST,E+D)self.bChoking=false end;E=d(E,0-C*2)self.avail=E;self.LastAvailUpdate=B;return E end;function ChatThrottleLib:Despool(t)local F=t.Ring;while F.pos and t.avail>F.pos[1].nSize do local q=b(t.Ring.pos,1)if not t.Ring.pos[1]then local l=t.Ring.pos;t.Ring:Remove(l)t.ByName[l.name]=nil;k(l)else t.Ring.pos=t.Ring.pos.next end;t.avail=t.avail-q.nSize;u=true;q.f(unpack(q,1,q.n))u=false;t.nTotalSent=t.nTotalSent+q.nSize;p(q)if q.callbackFn then q.callbackFn(q.callbackArg)end end end;function ChatThrottleLib.OnEvent(G,H)local self=ChatThrottleLib;if H=="PLAYER_ENTERING_WORLD"then self.HardThrottlingBeginTime=GetTime()self.avail=0 end end;function ChatThrottleLib.OnUpdate(G,I)local self=ChatThrottleLib;self.OnUpdateDelay=self.OnUpdateDelay+I;if self.OnUpdateDelay<0.08 then return end;self.OnUpdateDelay=0;self:UpdateAvail()if self.avail<0 then return end;local J=0;for K,t in pairs(self.Prio)do if t.Ring.pos or t.avail<0 then J=J+1 end end;if J<1 then for K,t in pairs(self.Prio)do self.avail=self.avail+t.avail;t.avail=0 end;self.bQueueing=false;self.Frame:Hide()return end;local E=self.avail/J;self.avail=0;for K,t in pairs(self.Prio)do if t.Ring.pos or t.avail<0 then t.avail=t.avail+E;if t.Ring.pos and t.avail>t.Ring.pos[1].nSize then self:Despool(t)end end end end;function ChatThrottleLib:Enqueue(K,L,q)local t=self.Prio[K]local l=t.ByName[L]if not l then self.Frame:Show()l=n()l.name=L;t.ByName[L]=l;t.Ring:Add(l)end;l[#l+1]=q;self.bQueueing=true end;function ChatThrottleLib:SendChatMessage(M,A,v,w,x,y,N,O,P)if not self or not M or not A or not v or not self.Prio[M]then error('Usage: ChatThrottleLib:SendChatMessage("{BULK||NORMAL||ALERT}", "prefix", "text"[, "chattype"[, "language"[, "destination"]]]',2)end;if O and type(O)~="function"then error("ChatThrottleLib:ChatMessage(): callbackFn: expected function, got "..type(O),2)end;local Q=v:len()if Q>255 then error("ChatThrottleLib:SendChatMessage(): message length cannot exceed 255 bytes",2)end;Q=Q+self.MSG_OVERHEAD;if not self.bQueueing and Q<self:UpdateAvail()then self.avail=self.avail-Q;u=true;_G.SendChatMessage(v,w,x,y)u=false;self.Prio[M].nTotalSent=self.Prio[M].nTotalSent+Q;if O then O(P)end;return end;local q=r()q.f=_G.SendChatMessage;q[1]=v;q[2]=w or"SAY"q[3]=x;q[4]=y;q.n=4;q.nSize=Q;q.callbackFn=O;q.callbackArg=P;self:Enqueue(M,N or A..(w or"SAY")..(y or""),q)end;function ChatThrottleLib:SendAddonMessage(M,A,v,w,R,N,O,P)if not self or not M or not A or not v or not w or not self.Prio[M]then error('Usage: ChatThrottleLib:SendAddonMessage("{BULK||NORMAL||ALERT}", "prefix", "text", "chattype"[, "target"])',2)end;if O and type(O)~="function"then error("ChatThrottleLib:SendAddonMessage(): callbackFn: expected function, got "..type(O),2)end;local Q=A:len()+1+v:len()if Q>255 then error("ChatThrottleLib:SendAddonMessage(): prefix + message length cannot exceed 254 bytes",2)end;Q=Q+self.MSG_OVERHEAD;if not self.bQueueing and Q<self:UpdateAvail()then self.avail=self.avail-Q;u=true;_G.SendAddonMessage(A,v,w,R)u=false;self.Prio[M].nTotalSent=self.Prio[M].nTotalSent+Q;if O then O(P)end;return end;local q=r()q.f=_G.SendAddonMessage;q[1]=A;q[2]=v;q[3]=w;q[4]=R;q.n=R~=nil and 4 or 3;q.nSize=Q;q.callbackFn=O;q.callbackArg=P;self:Enqueue(M,N or A..w..(R or""),q)end;ChatThrottleLib:Init()
